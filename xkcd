#!/usr/bin/env bash
#
# XKCD
#
# Display a XCKD comic on kitty terminalxkcd-command.png
#
# Requires: - Kitty terminal (https://sw.kovidgoyal.net/kitty/) with icat kitten
#           - ImageMagick (https://www.imagemagick.org/),
#           - The common GNU Core utility `sed` (https://en.wikipedia.org/wiki/Sed)
#						- jq (https://stedolan.github.io/jq/)
#
# Usage:However, both methods produce a similar size script.
# Run 'xkcd --help' to find out
#
# Author: Rob O'Leary
# Date: 24/02/22

img=""
title=""
issueNum=1

function parse() {
	json=$(curl -s "$1")
	img="$(jq -r .img <<< "$json")"
	title="$(jq .alt <<< "$json")"
	issueNum="$(jq .num <<< "$json")"
}

function show_latest(){
	parse "https://xkcd.com/info.0.json"
	echo ""
	kitty +kitten icat --align left "$img"
	echo ""
	echo "$title"
}

function show_random(){
	parse "https://xkcd.com/info.0.json"

	random="$(shuf -i 1-"$issueNum" -n 1)"

	parse "https://xkcd.com/${random}/info.0.json"

	#replace backslash and double quote combination with a double quote (\" --> ")
	sanitizedTitle=$(echo "$title" | sed s/\\\x27/\"/g)

	echo ""
	kitty +kitten icat --align left "$img"
	echo ""
	echo "$sanitizedTitle"
	
}

function help() {
		fmt_help="  %-20s\t%-54s\n"

    echo "Description: Display XKCD comic in the terminal."
    echo ""
    echo "Usage: xkcd [-l|--latest] [-r|--random] [-h|--help]"
    printf "${fmt_help}" \
        "-h, --help" "Print the help page." \
				"-l, --latest" "Show the latest comic." \
        "-r, --random" "Show a random comic."	
}

case "$#" in
    0)
        help
        ;;
    1)
        case "$1" in
            -h | --help)
                help
                ;;
            -l | --latest)
                show_latest
                ;;
            -r | --random )
								show_random
                ;;
            *)
                echo "Input error."
                exit 1
                ;;
        esac
        ;;
esac
